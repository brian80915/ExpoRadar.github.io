<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ›éšªé›·é”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal { transition: opacity 0.25s ease; }
        .modal-active { overflow: hidden; }
        .pulse-shadow { animation: pulse-shadow 2s infinite; }
        @keyframes pulse-shadow {
            0%, 100% { box-shadow: 0 0 10px rgba(244, 63, 94, 0.3), 0 0 20px rgba(244, 63, 94, 0.1); }
            50% { box-shadow: 0 0 15px rgba(244, 63, 94, 0.6), 0 0 30px rgba(244, 63, 94, 0.2); }
        }
        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #6366f1; cursor: pointer; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }
    </style>
</head>
<body class="bg-slate-950/90 min-h-screen pb-20">

<!-- æˆæ¬Šé©—è­‰æ¨¡æ…‹æ¡† (æ–°å¢) -->
<div id="authModal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center z-[9999] bg-slate-950/90 backdrop-blur-md opacity-0 pointer-events-none">
    <div class="glass w-11/12 md:max-w-sm mx-auto rounded-xl shadow-2xl p-8 text-center border-indigo-500/50">
        <h3 class="text-3xl font-bold text-yellow-400 mb-4"><i class="fa-solid fa-lock-open-file mr-2"></i> ç³»çµ±æˆæ¬Šé©—è­‰</h3>
        <p class="text-sm text-slate-400 mb-6">è«‹è¼¸å…¥å°ˆå±¬æˆæ¬Šç¢¼ä»¥è§£é–åŠŸèƒ½ã€‚</p>
        <input type="text" id="authCodeInput" placeholder="è«‹è¼¸å…¥æˆæ¬Šç¢¼" maxlength="4" class="w-full bg-slate-800 text-center text-2xl font-bold text-white p-3 rounded-lg border-2 border-slate-700 focus:border-indigo-500 focus:outline-none tracking-widest font-mono">
        <p id="authError" class="text-sm text-rose-400 mt-2 h-5"></p>
        <button onclick="window.handleAuthSubmit()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold mt-4 hover:bg-indigo-500 transition-colors">
            ç¢ºèªä¸¦é€²å…¥ç³»çµ±
        </button>
    </div>
</div>

<div class="pt-12 pb-4 px-6 bg-slate-900/90 backdrop-blur-md sticky top-0 z-50 border-b border-slate-800 flex justify-between items-center">
    <div class="flex items-center gap-2">
        <h1 class="text-lg font-bold tracking-wider text-white">
            <i class="fa-solid fa-gauge-high text-yellow-400"></i> æ›éšªé›·é”
        </h1>
    </div>
    <div class="flex items-center gap-3">
        <div id="cloudStatus" class="flex items-center gap-1 bg-slate-800 px-2 py-1 rounded-full border border-slate-700">
            <div class="w-2 h-2 rounded-full bg-gray-500" id="cloudDot"></div>
            <span class="text-[10px] text-gray-400 font-mono" id="cloudText">OFFLINE</span>
        </div>
        <button onclick="window.toggleModal('tutorialModal')" class="text-slate-400 hover:text-white transition-colors">
            <i class="fa-regular fa-circle-question text-xl"></i>
        </button>
    </div>
</div>

<div class="px-4 mt-6 max-w-lg mx-auto space-y-5">
    <button onclick="window.openRiskModal()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl shadow-lg font-bold text-sm flex justify-center items-center gap-2 hover:from-blue-500 hover:to-indigo-500 transition-all">
        <i class="fa-solid fa-clipboard-list"></i> ä¸çŸ¥é“å¦‚ä½•è¨­å®šï¼Ÿåšå€‹é¢¨éšªæ¸¬é©—
    </button>

    <div id="mainCard" class="glass rounded-2xl p-6 relative overflow-hidden shadow-2xl ring-1 ring-white/5">
        <div id="exposureBg" class="absolute inset-0 bg-slate-800/10 transition-colors duration-500"></div>
        <div class="relative z-10 text-center">
            <p class="text-slate-400 text-xs font-medium uppercase tracking-widest mb-1">ç¸½æ›éšªæ¯”ä¾‹ (Total Exposure Ratio)</p>
            <span id="riskBadge" class="inline-block text-xs font-semibold px-2 py-0.5 rounded-full mb-2 text-white bg-slate-600">è¼‰å…¥ä¸­</span>
            <div class="flex justify-center items-baseline gap-1">
                <p id="exposureDisplay" class="text-6xl font-bold tracking-tighter text-white transition-colors duration-500">0%</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-6 border-t border-white/10 pt-4">
                <div>
                    <p class="text-xs text-slate-400 mb-1">æ§“æ¡¿å€æ•¸</p>
                    <p id="leverageRatioDisplay" class="text-xl font-bold text-yellow-400 font-mono">0.00x</p>
                </div>
                <div>
                    <p class="text-xs text-slate-400 mb-1">æ·¨è³‡ç”¢ç¸½é¡</p>
                    <p id="netWorthDisplay" class="text-xl font-bold text-emerald-400 font-mono">$0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼¸å…¥å€å¡Š (ä¿æŒä¸è®Š) -->
    <div class="space-y-3">
        <div class="bg-slate-900 rounded-xl p-3 border-l-4 border-emerald-500 shadow flex items-center justify-between">
            <div class="flex flex-col"><label class="text-sm font-medium text-emerald-400 pl-1"><i class="fa-solid fa-sack-dollar w-5"></i> å¯æŠ•è³‡ç¾é‡‘</label><p class="text-xs text-slate-500 pl-1">å°ˆæ¬¾å°ˆç”¨</p></div>
            <input type="number" id="cash" placeholder="0" class="w-32 bg-transparent text-right text-lg font-bold text-white focus:outline-none font-mono placeholder-slate-700">
        </div>
        <div class="bg-slate-900 rounded-xl p-3 border-l-4 border-yellow-500 shadow space-y-2">
            <div class="flex items-center justify-between"><label class="text-sm font-medium text-yellow-400 pl-1"><i class="fa-solid fa-bolt w-5"></i> é«˜æ³¢å‹•/æ§“æ¡¿éƒ¨ä½ç¸½å¸‚å€¼(æ§“æ¡¿ETFã€æœŸè²¨)</label><input type="number" id="stock2x" placeholder="0" class="w-32 bg-transparent text-right text-lg font-bold text-white focus:outline-none font-mono placeholder-slate-700"></div>
            <div class="flex items-center justify-between pt-1 border-t border-slate-800 text-slate-400 text-xs">å¯¦éš›æ§“æ¡¿ (å¦‚: 2, 3)<input type="number" id="leverageMultiplier" value="2" min="1" step="0.5" placeholder="2" class="w-16 bg-slate-800/50 rounded p-1 text-center text-sm font-mono text-white focus:outline-none"></div>
        </div>
        <div class="bg-slate-900 rounded-xl p-3 border-l-4 border-yellow-600 shadow flex items-center justify-between">
            <label class="text-sm font-medium text-yellow-500 pl-1"><i class="fa-solid fa-layer-group w-5"></i> ä¸€èˆ¬è‚¡å¸‚ç¸½å¸‚å€¼ (1X)</label><input type="number" id="stock1x" placeholder="0" class="w-32 bg-transparent text-right text-lg font-bold text-white focus:outline-none font-mono placeholder-slate-700">
        </div>
        <div class="bg-slate-900 rounded-xl p-3 border-l-4 border-rose-500 shadow flex items-center justify-between relative overflow-hidden">
            <div class="absolute inset-0 bg-rose-500/5 pointer-events-none"></div>
            <div class="flex flex-col"><label class="text-sm font-medium text-rose-400 pl-1"><i class="fa-solid fa-hand-holding-dollar w-5"></i> è³ªæŠ¼å€Ÿè²¸</label><p class="text-xs text-slate-500 pl-1">è‚¡ç¥¨æ“”ä¿</p></div>
            <input type="number" id="collateralLoan" placeholder="0" class="w-32 bg-transparent text-right text-lg font-bold text-white focus:outline-none font-mono placeholder-slate-700">
        </div>
        <div class="bg-slate-900 rounded-xl p-3 border-l-4 border-rose-700 shadow flex items-center justify-between"><div class="flex flex-col"><label class="text-sm font-medium text-rose-300 pl-1"><i class="fa-solid fa-house-chimney-crack w-5"></i> ä¸€èˆ¬è²¸æ¬¾</label><p class="text-xs text-slate-500 pl-1">ä¿¡è²¸</p></div><input type="number" id="generalLoan" placeholder="0" class="w-32 bg-transparent text-right text-lg font-bold text-white focus:outline-none font-mono placeholder-slate-700"></div>
        <div class="bg-slate-900 rounded-xl p-3 border-l-4 border-cyan-500 shadow flex items-center justify-between"><label class="text-sm font-medium text-cyan-400 pl-1"><i class="fa-solid fa-city w-5"></i> æˆ¿ç”¢å¸‚å€¼</label><input type="number" id="realEstateMarketValue" placeholder="0" class="w-32 bg-transparent text-right text-lg font-bold text-white focus:outline-none font-mono placeholder-slate-700"></div>
        <div class="bg-slate-900 rounded-xl p-3 border-l-4 border-cyan-700 shadow flex items-center justify-between"><label class="text-sm font-medium text-cyan-300 pl-1"><i class="fa-solid fa-file-invoice-dollar w-5"></i> æˆ¿è²¸é¤˜é¡</label><input type="number" id="mortgageBalance" placeholder="0" class="w-32 bg-transparent text-right text-lg font-bold text-white focus:outline-none font-mono placeholder-slate-700"></div>
    </div>
    
    <!-- è¨­å®šå€å¡Š (ä¿æŒä¸è®Š) -->
    <div class="bg-slate-900 rounded-xl p-3 border-l-4 border-indigo-500 shadow space-y-3">
        <div class="flex items-center justify-between"><label class="text-sm font-medium text-indigo-400 pl-1">ğŸ¯ ç›®æ¨™æ›éšª (%)</label><input type="number" id="targetExposure" value="130" class="w-16 bg-slate-800/50 rounded p-1 text-center text-lg font-bold text-white font-mono"></div>
        <div class="flex items-center justify-between"><label class="text-sm font-medium text-indigo-400 pl-1">Â± å®¹å¿åº¦ (%)</label><input type="number" id="tolerance" value="5" class="w-16 bg-slate-800/50 rounded p-1 text-center text-lg font-bold text-white font-mono"></div>
        <div class="flex items-center justify-between pt-2 border-t border-slate-800 text-xs text-slate-400">æˆ¿ç”¢æ·¨å€¼ç´å…¥æ·¨è³‡ç”¢åˆ†æ¯<input type="checkbox" id="reToggle" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-indigo-500 focus:ring-indigo-500"></div>
        <div class="flex items-center justify-between text-xs text-slate-400">æˆ¿ç”¢æ·¨å€¼è¨ˆå…¥ 1X æ›éšª (æ¿€é€²)<input type="checkbox" id="reExpToggle" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-indigo-500 focus:ring-indigo-500"></div>
    </div>

    <!-- æ•¸æ“šç®¡ç† (ä¿æŒä¸è®Š) -->
    <div class="bg-slate-900 rounded-xl p-4 border-l-4 border-purple-500 shadow mt-5">
        <h3 class="text-sm font-bold text-purple-400 mb-3 flex items-center gap-2"><i class="fa-solid fa-cloud-arrow-up"></i> æ•¸æ“šç®¡ç†</h3>
        <div class="grid grid-cols-3 gap-3">
            <button id="btnSave" class="col-span-1 py-2 rounded-lg text-sm font-bold bg-purple-600 hover:bg-purple-500 transition-colors text-white"><i class="fa-solid fa-cloud-arrow-up mr-1"></i> å­˜æª”</button>
            <button id="btnBackup" class="col-span-1 py-2 rounded-lg text-sm font-bold bg-sky-600 hover:bg-sky-500 transition-colors text-white"><i class="fa-solid fa-download mr-1"></i> åŒ¯å‡ºå‚™ä»½</button>
            <label for="fileImport" class="col-span-1 py-2 rounded-lg text-sm font-bold bg-green-600 hover:bg-green-500 transition-colors text-white text-center cursor-pointer"><i class="fa-solid fa-file-import mr-1"></i> åŒ¯å…¥é‚„åŸ</label>
            <input id="fileImport" type="file" accept="application/json" hidden>
        </div>
        <p class="text-[10px] text-slate-500 mt-2 text-center">ã€‚</p>
    </div>

    <!-- ç¶­æŒç‡å¡ç‰‡ (å«è‡ªå®šç¾©æ»‘æ¡¿) (ä¿æŒä¸è®Š) -->
    <div id="mtnCard" class="hidden glass rounded-xl p-4 border border-slate-700 shadow-lg space-y-3">
        <div class="flex justify-between items-center">
            <h3 class="text-sm font-bold text-slate-300 flex items-center gap-2"><i class="fa-solid fa-shield-halved"></i> æ“”ä¿å“ç¶­æŒç‡</h3>
            <span id="mtnBadge" class="text-[10px] px-2 py-0.5 rounded transition-colors duration-500 bg-slate-500 text-white">Safe</span>
        </div>
        <div class="flex items-baseline justify-between mb-1 text-white text-2xl font-bold font-mono">
            <span id="mtnValue">0%</span>
            <span class="text-sm text-slate-400">è­¦æˆ’ç·š: 130%</span>
        </div>
        <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
            <div id="mtnBar" class="h-full bg-emerald-500 transition-all duration-500" style="width: 0%"></div>
        </div>
        <p id="mtnDesc" class="text-xs text-slate-400 mt-2">ç›®å‰ç¶­æŒç‡å¥åº·ï¼Œç„¡è¿½ç¹³é¢¨éšªã€‚</p>
        
        <!-- NEW: Custom Drop Slider -->
        <div class="bg-slate-800/50 rounded-lg p-3 mt-2 border border-slate-700/50">
            <div class="flex justify-between items-center mb-2">
                <label class="text-xs font-bold text-indigo-300 flex items-center gap-1"><i class="fa-solid fa-arrow-trend-down"></i> æ¨¡æ“¬å¸‚å ´è·Œå¹…</label>
                <span id="dropPercentDisplay" class="text-sm font-mono font-bold text-yellow-400 bg-slate-900 px-2 py-0.5 rounded border border-slate-700">-20%</span>
            </div>
            <input type="range" id="dropSlider" min="5" max="50" step="5" value="20" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500 hover:accent-indigo-400 transition-all">
            <div class="flex justify-between text-[9px] text-slate-500 mt-1 px-1 font-mono">
                <span>-5%</span>
                <span>-25%</span>
                <span>-50%</span>
            </div>
        </div>

        <button id="simulateBtn" onclick="window.simulateRisk()" class="w-full py-2 rounded-lg text-sm font-bold bg-indigo-600 hover:bg-indigo-500 transition-colors mt-2 disabled:bg-slate-700 shadow-lg border border-indigo-500/50">
            âœ¨ åŸ·è¡Œå£“åŠ›æ¸¬è©¦
        </button>
    </div>

    <!-- LLM åˆ†æçµæœ (ä¿æŒä¸è®Š) -->
    <div id="llmResultCard" class="hidden glass rounded-xl p-4 border-l-4 border-indigo-500 shadow-xl mt-4">
        <div class="flex items-center gap-2 mb-2">
            <i class="fa-solid fa-robot text-indigo-400"></i>
            <h3 class="text-sm font-bold text-indigo-400">é¢¨éšªåˆ†æå ±å‘Š</h3>
            <div id="llmLoader" class="hidden w-4 h-4 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <p id="llmResultText" class="text-sm text-slate-300 whitespace-pre-wrap">...</p>
    </div>

    <!-- å»ºè­°æ“ä½œå¡ç‰‡ (ä¿æŒä¸è®Š) -->
    <div id="actionCard" class="hidden mt-4 transform transition-all duration-500">
        <div class="rounded-xl p-5 border-l-4 shadow-lg bg-slate-800 border-slate-600 relative">
            <div class="flex justify-between items-start mb-2">
                <h3 id="actionTitle" class="text-base font-bold text-white">åˆ†æä¸­...</h3>
                <span id="actionBadge" class="text-[10px] px-2 py-0.5 rounded text-white bg-slate-500">INIT</span>
            </div>
            <p id="actionDesc" class="text-sm text-slate-400 mb-3">...</p>
            <div class="space-y-3 text-white">
                <div class="bg-slate-950/50 rounded-lg p-3 flex justify-between items-center border border-slate-700/50"><p class="text-sm text-slate-400">1X åŸºæº–èª¿æ•´ (ä¸€èˆ¬è‚¡ç¥¨)</p><p id="actionAmount1x" class="font-bold text-lg font-mono text-white">$0</p></div>
                <div class="bg-slate-950/50 rounded-lg p-3 flex justify-between items-center border border-slate-700/50"><p class="text-sm text-slate-400">N-X åŸºæº–èª¿æ•´ (æ§“æ¡¿éƒ¨ä½)</p><p id="actionAmountNx" class="font-bold text-lg font-mono text-white">$0</p></div>
            </div>
            <p id="actionNote" class="text-[10px] text-slate-600 mt-3 italic">**æ³¨æ„:** è‹¥ç¾é‡‘ç‚º0ä¸”æ›éšª100%ï¼Œè«‹æ”¹ç”¨ã€Œå¸‚å€¼å€é–“ã€é€²è¡Œæ“ä½œã€‚</p>
        </div>
    </div>

    <div class="mt-8 text-center text-[10px] text-slate-600">Logic v13.8.2 | Custom Drop Simulation</div>
</div>

<!-- Risk Modal (ä¿æŒä¸è®Š) -->
<div id="riskModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
    <div class="modal-overlay absolute w-full h-full bg-black opacity-80" onclick="window.toggleModal('riskModal')"></div>
    <div class="modal-container bg-slate-900 w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
        <div class="modal-content py-4 text-left px-6">
            <div class="flex justify-between items-center pb-3 border-b border-slate-700">
                <p class="text-xl font-bold text-white">ğŸ“‹ é¢¨éšªæ‰¿å—åº¦æ¸¬é©—</p>
                <div class="modal-close cursor-pointer z-50" onclick="window.toggleModal('riskModal')"><i class="fa-solid fa-xmark text-slate-400"></i></div>
            </div>
            <div id="riskQuestions" class="my-5 space-y-6">
                <div><p class="text-sm font-bold text-indigo-400 mb-2">1. æ‚¨çš„æŠ•è³‡ç¶“é©—æœ‰å¤šä¹…ï¼Ÿ</p><select id="q1" class="w-full bg-slate-800 text-white p-2 rounded border border-slate-600 focus:border-indigo-500 outline-none"><option value="0">å°‘æ–¼ 3 å¹´ (æ–°æ‰‹)</option><option value="1">3 - 10 å¹´ (æœ‰ç¶“é©—)</option><option value="2">è¶…é 10 å¹´ (è€æ‰‹)</option></select></div>
                <div><p class="text-sm font-bold text-indigo-400 mb-2">2. å¦‚æœè‚¡å¸‚ä¸‹è·Œ 20%ï¼Œæ‚¨æœƒï¼Ÿ</p><select id="q2" class="w-full bg-slate-800 text-white p-2 rounded border border-slate-600 focus:border-indigo-500 outline-none"><option value="0">æ„Ÿåˆ°ææ…Œï¼Œè³£å‡ºæ­¢æ</option><option value="1">æŒ‰å…µä¸å‹•ï¼Œè§€æœ›å¸‚å ´</option><option value="2">æ„Ÿåˆ°èˆˆå¥®ï¼ŒåŠ ç¢¼è²·é€²</option></select></div>
                <div><p class="text-sm font-bold text-indigo-400 mb-2">3. æ‚¨ä½¿ç”¨éæ§“æ¡¿ç”¢å“å—ï¼Ÿ</p><select id="q3" class="w-full bg-slate-800 text-white p-2 rounded border border-slate-600 focus:border-indigo-500 outline-none"><option value="0">å¾æœªä½¿ç”¨ï¼Œä¹Ÿä¸å¤ªäº†è§£</option><option value="1">å¶çˆ¾ä½¿ç”¨ï¼Œäº†è§£é¢¨éšª</option><option value="2">ç¶“å¸¸ä½¿ç”¨ï¼Œæ˜¯æˆ‘çš„ä¸»è¦ç­–ç•¥</option></select></div>
                <div><p class="text-sm font-bold text-indigo-400 mb-2">4. æ‚¨åå¥½å¤šä¹…é€²è¡Œä¸€æ¬¡å†å¹³è¡¡ï¼Ÿ</p><select id="q4" class="w-full bg-slate-800 text-white p-2 rounded border border-slate-600 focus:border-indigo-500 outline-none"><option value="0">åªåœ¨å¸‚å ´åŠ‡çƒˆæ³¢å‹• (å¯¬é¬† / Â±15%)</option><option value="1">è®“å¸‚å ´è‡ªç”±æ³¢å‹• (é©ä¸­ / Â±10%)</option><option value="2" selected>è¿½æ±‚æ¥µè‡´ç´€å¾‹ (åš´è¬¹ / Â±5%)</option></select></div>
                <div class="flex justify-end pt-2"><button onclick="window.analyzeRisk()" class="w-full px-4 py-3 bg-indigo-600 rounded-lg text-white font-bold hover:bg-indigo-500 transition-colors">åˆ†æçµæœ</button></div>
            </div>
            <div id="riskResults" class="hidden my-5 text-center">
                <div class="bounce-in mb-4 flex justify-center"><div id="resultIconContainer" class="w-24 h-24 rounded-full bg-slate-800 flex items-center justify-center border-4 border-indigo-500 shadow-[0_0_20px_rgba(99,102,241,0.5)]"><i id="resultIcon" class="fa-solid fa-shield-halved text-4xl text-indigo-400"></i></div></div>
                <h3 id="resultTitle" class="text-2xl font-bold text-white mb-2">ç©©å¥å¹³è¡¡å‹</h3>
                <p id="resultDesc" class="text-sm text-slate-400 mb-6 px-2">...</p>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700"><p class="text-xs text-slate-500 mb-1">å»ºè­°ç›®æ¨™æ›éšª</p><p id="resultTarget" class="text-xl font-bold text-white font-mono">80%</p></div>
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700"><p class="text-xs text-slate-500 mb-1">å»ºè­°å®¹å¿ç¯„åœ</p><p id="resultTolerance" class="text-xl font-bold text-white font-mono">Â±5%</p></div>
                </div>
                <button onclick="window.confirmRiskSettings()" class="w-full px-4 py-3 bg-green-600 rounded-lg text-white font-bold hover:bg-green-500 transition-colors mb-2"><i class="fa-solid fa-check mr-2"></i> å¥—ç”¨æ­¤è¨­å®š</button>
                <button onclick="window.resetRiskModal()" class="w-full px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors">é‡æ–°æ¸¬é©—</button>
            </div>
        </div>
    </div>
</div>

<!-- Tutorial Modal (ä¿æŒä¸è®Š) -->
<div id="tutorialModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
    <div class="modal-overlay absolute w-full h-full bg-black opacity-80" onclick="window.toggleModal('tutorialModal')"></div>
    <div class="modal-container bg-slate-900 w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
        <div class="modal-content py-4 text-left px-6">
            <div class="flex justify-between items-center pb-3 border-b border-slate-700"><p class="text-xl font-bold text-white">ğŸ“˜ App ä½¿ç”¨æ•™å­¸</p><div class="modal-close cursor-pointer z-50" onclick="window.toggleModal('tutorialModal')"><i class="fa-solid fa-xmark text-slate-400"></i></div></div>
            <div class="my-4 space-y-4 text-sm text-slate-300 h-96 overflow-y-scroll pr-2 scrollbar-thin">
                 <div class="space-y-2"><h3 class="text-indigo-400 font-bold">1. æ ¸å¿ƒæ¦‚å¿µ</h3><p>æœ¬å·¥å…·å¹«åŠ©æ‚¨ç›£æ§ã€ŒæŠ•è³‡ç¸½æ›éšªã€ä½”ã€Œç¸½æ·¨è³‡ç”¢ã€çš„æ¯”ä¾‹ã€‚é€éæ§åˆ¶é€™å€‹æ¯”ä¾‹ï¼Œå¯¦ç¾ä½è²·é«˜è³£çš„ç´€å¾‹æŠ•è³‡ã€‚</p>
                </div>
                <div class="space-y-2">
                    <h3 class="text-indigo-400 font-bold">2. æ¬„ä½å¡«å¯«æŒ‡å—</h3>
                    <ul class="list-disc pl-4 space-y-1 text-slate-400 text-xs">
                        <li><strong class="text-white">å¯æŠ•è³‡ç¾é‡‘ï¼š</strong>å°ˆæ¬¾å°ˆç”¨æŠ•è³‡é–’éŒ¢ã€‚</li>
                        <li><strong class="text-white">é«˜æ³¢å‹•/æ§“æ¡¿éƒ¨ä½(æ§“æ¡¿ETFã€æœŸè²¨)ï¼š</strong>å¦‚ TQQQ, 00675Lã€‚</li>
                        <li><strong class="text-white">è³ªæŠ¼å€Ÿè²¸ï¼š</strong>è‚¡ç¥¨æŠµæŠ¼å€Ÿæ¬¾ï¼Œæœƒè¨ˆç®—ç¶­æŒç‡ã€‚</li>
                        <li><strong class="text-white">ä¸€èˆ¬è²¸æ¬¾ï¼š</strong>ä¿¡è²¸ã€å…¶ä»–è²¸æ¬¾ã€‚</li>
                    </ul>
                </div>
                <div class="space-y-2">
                        <h3 class="text-indigo-400 font-bold">3. æˆ¿ç”¢è¨­å®š</h3>
                        <p>æˆ¿ç”¢æ·¨å€¼æœƒå¢åŠ æ‚¨çš„ã€Œæ·¨è³‡ç”¢åˆ†æ¯ã€ï¼Œè®“æ§“æ¡¿æ¯”ä¾‹çœ‹èµ·ä¾†æ¯”è¼ƒå¥åº·ï¼ˆç”Ÿå‘½é€±æœŸæŠ•è³‡æ³•ï¼‰ã€‚è‹¥æ‚¨å¸Œæœ›æ¡å–æ›´æ¿€é€²çš„ç®—æ³•ï¼Œå¯é–‹å•Ÿã€Œè¨ˆå…¥æˆ¿ç”¢ 1X æ›éšªã€ã€‚</p>
                    </div>
                <div class="space-y-2">
                        <h3 class="text-indigo-400 font-bold">4. å†å¹³è¡¡æ“ä½œ</h3>
                        <p>ç•¶æ›éšªæ¯”ä¾‹ä½æ–¼æˆ–è¶…éæ‚¨è¨­å®šçš„ç›®æ¨™æ™‚ï¼Œç³»çµ±æœƒå»ºè­°æ‚¨ã€Œè²·å…¥ã€æˆ–ã€Œè³£å‡ºã€ä¾†é€²è¡Œå†å¹³è¡¡ã€‚</p>
                        <p>ç•¶ç¸½æ›é¡¯é”100%,ä¸”ç¾é‡‘ç‚º0æ™‚ã€‚æ”¹ä½¿ç”¨è‚¡ç¥¨å¸‚å€¼åŸ·è¡Œå†å¹³è¡¡èª¿æ•´ã€‚é€šéä½¿ç”¨åƒ¹å€¼å€é–“è€Œéå–®ç´”çš„æ›éšªæ¯”ä¾‹,å¯ä»¥ç¢ºä¿è³‡ç”¢æ³¢å‹•æ™‚èƒ½é€²è¡Œç´€å¾‹æ€§çš„ä½è²·é«˜è³£æ“ä½œã€‚</p>
                    </div>
                 <div class="space-y-2">
                        <h3 class="text-indigo-400 font-bold">5. å®¹å¿åº¦ (Tolerance Â±%)</h3>
                        <p>é€™æ˜¯æ‚¨é¡˜æ„è®“å¯¦éš›æ›éšªæ¯”ä¾‹åé›¢ã€Œç›®æ¨™æ›éšªã€çš„æœ€å¤§ç¯„åœã€‚å®¹å¿åº¦è¶Šä½ï¼Œå†å¹³è¡¡çš„é »ç‡å°±è¶Šé«˜ï¼Œè¶Šèƒ½ç¶­æŒåš´è¬¹çš„ç´€å¾‹ï¼›å®¹å¿åº¦è¶Šé«˜ï¼Œå‰‡äº¤æ˜“æ¬¡æ•¸è¶Šå°‘ï¼Œä½†å…è¨±æ›éšªæœ‰æ›´å¤§çš„æµ®å‹•è®ŠåŒ–ã€‚</p>
                        <ul class="list-disc pl-4 space-y-1 text-slate-400 text-xs">
                            <li><strong class="text-white">åš´è¬¹ç´€å¾‹ (Â±5%)ï¼š</strong>è¿½æ±‚ç²¾ç¢ºï¼Œå°å¹…åé›¢å³èª¿æ•´ã€‚äº¤æ˜“é »ç‡é«˜ã€‚</li>
                            <li><strong class="text-white">é©ä¸­å¹³è¡¡ (Â±10%)ï¼š</strong>è®“å¸‚å ´è‡ªç”±æ³¢å‹•ï¼Œåªåœ¨å¤ å¤§åå·®æ™‚æ‰èª¿æ•´ã€‚äº¤æ˜“é »ç‡é©ä¸­ã€‚</li>
                            <li><strong class="text-white">å¯¬é¬†æ‡‰å° (Â±15%)ï¼š</strong>äº¤æ˜“æ¥µå°‘ï¼Œåªåœ¨å¸‚å ´åŠ‡çƒˆè®Šå‹•æ™‚æ‰èª¿æ•´ã€‚äº¤æ˜“é »ç‡ä½ã€‚</li> 
                     </div>     
                <div class="space-y-2">
                <div class="space-y-2"><h3 class="text-indigo-400 font-bold">6. æ¨¡æ“¬è·Œå¹…</h3><p>æ»‘æ¡¿åŠŸèƒ½ï¼Œå¯è‡ªç”±è¨­å®š -5% è‡³ -50% çš„å¸‚å ´è·Œå¹…æƒ…å¢ƒï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—å°æ‡‰çš„ç¶­æŒç‡è®ŠåŒ–èˆ‡è£œç¹³ä¿è­‰é‡‘éœ€æ±‚ã€‚</p></div>
            </div>
            <p class="text-center text-xs text-slate-500 mt-8">Â© 2025 å¸ƒèŠæ© | ç›®å‰ç‚ºå…§æ¸¬ç‰ˆæœ¬ï¼Œæœªç¶“æˆæ¬Šè«‹å‹¿äºŒæ¬¡æ•£å¸ƒ</p>
        </div>
    </div>
</div>

<div id="toastContainer" class="fixed bottom-4 right-4 z-[9999] space-y-2"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let auth, db, user, appId = 'default-app', isCloudEnabled = false;
    const AUTH_CODE = 'E688'; //
    const STORAGE_KEY = 'exposure_v1';
    const inputIds = ['cash', 'stock2x', 'stock1x', 'collateralLoan', 'generalLoan', 'realEstateMarketValue', 'mortgageBalance', 'leverageMultiplier', 'targetExposure', 'tolerance'];
    const toggleIds = ['reToggle', 'reExpToggle'];
    const STATE_FIELDS = [...inputIds, ...toggleIds];
    let els = {}, btnSave, btnBackup, fileImport, cloudStatus, cloudDot, cloudText;

    // Elements
    function initEls() {
        inputIds.forEach(id => els[id] = document.getElementById(id));
        toggleIds.forEach(id => els[id] = document.getElementById(id));
        btnSave = document.getElementById('btnSave'); btnBackup = document.getElementById('btnBackup'); fileImport = document.getElementById('fileImport');
        cloudStatus = document.getElementById('cloudStatus'); cloudDot = document.getElementById('cloudDot'); cloudText = document.getElementById('cloudText');
        
        // Slider Listener
        const dropSlider = document.getElementById('dropSlider');
        const dropDisplay = document.getElementById('dropPercentDisplay');
        if(dropSlider) {
            dropSlider.addEventListener('input', (e) => {
                dropDisplay.innerText = `-${e.target.value}%`;
            });
        }
    }

    // Logic
    function snapshotState() {
        const s = {};
        STATE_FIELDS.forEach(id => { const el = els[id]; if (!el) return; s[id] = el.type === 'checkbox' ? !!el.checked : (el.value ?? ''); });
        return s;
    }
    function applyState(state) {
        if (!state) return;
        STATE_FIELDS.forEach(id => { const el = els[id]; if (!el) return; if (id in state) { if (el.type === 'checkbox') el.checked = !!state[id]; else el.value = state[id]; } });
        window.calculate();
    }
    function updateCloudStatus(status) {
        if (status === 'connected') { cloudDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse"; cloudText.innerText = "CLOUD SYNC"; cloudText.className = "text-[10px] text-green-400 font-mono"; isCloudEnabled = true; }
        else if (status === 'saving') { cloudDot.className = "w-2 h-2 rounded-full bg-yellow-500 animate-bounce"; cloudText.innerText = "SAVING..."; cloudText.className = "text-[10px] text-yellow-400 font-mono"; }
        else { cloudDot.className = "w-2 h-2 rounded-full bg-gray-500"; cloudText.innerText = "LOCAL MODE"; cloudText.className = "text-[10px] text-gray-400 font-mono"; isCloudEnabled = false; }
    }

    // Storage
    async function saveStateToStorage(isManual = false) {
        const state = snapshotState();
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) { console.warn("Local failed", e); }
        if (isCloudEnabled && user && db) {
            if (isManual) updateCloudStatus('saving');
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'exposure_settings');
                await setDoc(docRef, state);
                if (isManual) { showToast('âœ… å·²å­˜æª”æˆåŠŸï¼', 'success'); setTimeout(() => updateCloudStatus('connected'), 1000); }
            } catch (e) { console.error("Cloud save failed", e); if (isManual) showToast('âŒ å­˜æª”å¤±æ•—ï¼Œåƒ…ä¿å­˜æ–¼æœ¬æ©Ÿ', 'error'); updateCloudStatus('error'); }
        } else if (isManual) { showToast('âš ï¸ åƒ…ä¿å­˜æ–¼æœ¬æ©Ÿ (æœªé€£ç·š)', 'info'); }
    }
    const autoSave = (fn, wait = 500) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); }; };
    const debouncedSave = autoSave(() => saveStateToStorage(false), 1000);

    // Firebase
    async function initFirebase() {
        try {
            if (true) throw new Error("No config");  // ç›´æ¥è·³é Firebase åˆå§‹åŒ–
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app); db = getFirestore(app);
            if (typeof __app_id !== 'undefined') appId = __app_id;
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            };
            await initAuth();
            onAuthStateChanged(auth, (u) => {
                if (u) {
                    user = u; updateCloudStatus('local');  // å¼·åˆ¶é¡¯ç¤ºæœ¬åœ°æ¨¡å¼
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'exposure_settings');
                    onSnapshot(docRef, (docSnap) => {
                        // åƒ…åœ¨åˆå§‹è¼‰å…¥æ™‚ï¼ˆinputçš†ç‚ºç©ºï¼‰è¼‰å…¥é›²ç«¯è³‡æ–™ï¼Œé¿å…è¦†è“‹ä½¿ç”¨è€…ç•¶å‰æ“ä½œ
                        const isInitialLoad = !els.cash.value && !els.stock2x.value; 
                        if (docSnap.exists() && isInitialLoad) { applyState(docSnap.data()); showToast('â˜ï¸ å·²è¼‰å…¥é›²ç«¯ç´€éŒ„', 'info'); }
                    });
                }
            });
        } catch (e) { 
            console.warn("Firebase Init Failed:", e); 
            updateCloudStatus('local'); 
            const localData = localStorage.getItem(STORAGE_KEY); 
            if (localData) applyState(JSON.parse(localData)); 
        }
    }

    // Events
    function attachEvents() {
        STATE_FIELDS.forEach(id => { const el = els[id]; if (el) { el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', () => { window.calculate(); debouncedSave(); }); } });
        if (btnSave) btnSave.onclick = () => saveStateToStorage(true);
        if (btnBackup) btnBackup.onclick = () => {
            const blob = new Blob([JSON.stringify(snapshotState(), null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `exposure_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); showToast('â¬‡ï¸ å‚™ä»½å·²ä¸‹è¼‰', 'success');
        };
        if (fileImport) fileImport.onchange = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader(); reader.onload = (ev) => { try { applyState(JSON.parse(ev.target.result)); saveStateToStorage(true); showToast('â¬†ï¸ åŒ¯å…¥æˆåŠŸä¸¦åŒæ­¥', 'success'); } catch { showToast('âŒ åŒ¯å…¥å¤±æ•—', 'error'); } }; reader.readAsText(file); e.target.value = null;
        };
    }

    // Helpers
    function getRiskCategory(ratio) { if (ratio < 50) return { level: 'ä½é¢¨éšª', color: 'emerald' }; if (ratio < 100) return { level: 'ä¸­ä½é¢¨éšª', color: 'green' }; if (ratio < 150) return { level: 'ä¸­é¢¨éšª', color: 'amber' }; if (ratio < 200) return { level: 'ä¸­é«˜é¢¨éšª', color: 'orange' }; if (ratio < 300) return { level: 'é«˜é¢¨éšª', color: 'rose' }; return { level: 'æ¥µé«˜é¢¨éšª', color: 'red' }; }
    
    function updateRiskDisplay(expRatio) {
        const risk = getRiskCategory(expRatio);
        const riskBadge = document.getElementById('riskBadge');
        const expBg = document.getElementById('exposureBg');
        const expDisp = document.getElementById('exposureDisplay');

        if (riskBadge) { 
            riskBadge.innerText = risk.level; 
            riskBadge.className = `inline-block text-xs font-semibold px-2 py-0.5 rounded-full mb-2 text-white bg-${risk.color}-600`; 
        }
        if (expBg) { 
            expBg.className = `absolute inset-0 transition-colors duration-500 bg-${risk.color}-500/10`;
        }
        
        if (expDisp) { 
            // Reset base classes
            expDisp.className = `text-6xl font-bold tracking-tighter transition-colors duration-500`;
            expDisp.classList.remove('text-rose-400', 'pulse-shadow'); 
            expDisp.classList.add('text-white'); // Default color

            if (expRatio >= 200) {
                expDisp.classList.add('text-rose-400', 'pulse-shadow');
                expDisp.classList.remove('text-white'); // Override default color for high risk
            } 
        }
    }
    
    // Global Window
    window.toggleModal = (id) => { const el = document.getElementById(id); if (el) { el.classList.toggle('opacity-0'); el.classList.toggle('pointer-events-none'); } };
    let pTarget = 100, pTol = 5;
    window.openRiskModal = () => { document.getElementById('riskQuestions').classList.remove('hidden'); document.getElementById('riskResults').classList.add('hidden'); window.toggleModal('riskModal'); };
    window.resetRiskModal = window.openRiskModal;
    window.analyzeRisk = () => {
        const score = ['q1','q2','q3'].map(id=>parseInt(document.getElementById(id).value)).reduce((a,b)=>a+b,0);
        const q4 = parseInt(document.getElementById('q4').value);
        
        if (score <= 1) pTarget = 60; else if (score <= 3) pTarget = 80; else if (score <= 4) pTarget = 110; else pTarget = 130;
        pTol = q4 === 0 ? 15 : (q4 === 1 ? 10 : 5);
        
        document.getElementById('resultTarget').innerText = pTarget + "%"; 
        document.getElementById('resultTolerance').innerText = "Â±" + pTol + "%";
        
        // Refactored Icon logic for robustness
        let iconClass = "fa-shield-halved"; 
        let colorClass = "border-emerald-500 text-emerald-400";
        if (score > 1 && score <= 3) { iconClass = "fa-scale-balanced"; colorClass = "border-blue-500 text-blue-400"; } 
        else if (score > 3 && score <= 4) { iconClass = "fa-chart-line"; colorClass = "border-amber-500 text-amber-400"; } 
        else if (score > 4) { iconClass = "fa-rocket"; colorClass = "border-rose-500 text-rose-400"; }
        
        const ic = document.getElementById('resultIconContainer'), i = document.getElementById('resultIcon');
        ic.className = `w-24 h-24 rounded-full bg-slate-800 flex items-center justify-center border-4 ${colorClass} shadow-[0_0_20px_rgba(255,255,255,0.1)]`;
        i.className = `fa-solid ${iconClass} text-4xl text-white`;
        
        document.getElementById('riskQuestions').classList.add('hidden'); 
        document.getElementById('riskResults').classList.remove('hidden');
    };
    window.confirmRiskSettings = () => { els.targetExposure.value = pTarget; els.tolerance.value = pTol; window.calculate(); debouncedSave(); window.toggleModal('riskModal'); };

    // Core Calc
    window.calculate = () => {
        const val = (id) => parseFloat(els[id]?.value) || 0;
        const vCash = val('cash'), vS2 = val('stock2x'), vS1 = val('stock1x'), vLoan = val('collateralLoan'), vGenLoan = val('generalLoan'), vRE = val('realEstateMarketValue'), vMort = val('mortgageBalance'), vMult = val('leverageMultiplier') || 2, vTar = val('targetExposure') || 130, vTol = val('tolerance') || 5;
        let net = vCash + vS2 + vS1 - (vLoan + vGenLoan) + (vRE - vMort);
        if (!els.reToggle.checked) net -= (vRE - vMort);
        let exp = (vS2 * vMult) + vS1;
        if (els.reExpToggle.checked) exp += (vRE - vMort);
        
        const disp = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt; };
        
        if (net <= 0) { 
            disp('exposureDisplay', 'N/A'); 
            disp('leverageRatioDisplay', 'N/A'); 
        } else {
            const r = (exp/net)*100;
            disp('exposureDisplay', r.toFixed(0) + "%"); 
            disp('leverageRatioDisplay', (exp/net).toFixed(2) + "x");
            updateRiskDisplay(r);
            
            const actionCard = document.getElementById('actionCard'); 
            actionCard.classList.remove('hidden');
            
            const diff = (net * (vTar/100)) - exp;
            const title = document.getElementById('actionTitle'), amt1 = document.getElementById('actionAmount1x'), amtN = document.getElementById('actionAmountNx'), badge = document.getElementById('actionBadge');
            
            if (Math.abs(r - vTar) <= vTol) { 
                title.innerText = "å®‰å…¨æŒæœ‰ (HOLD)"; 
                title.className = "text-base font-bold text-emerald-400"; 
                amt1.innerText = "ç¶­æŒç¾ç‹€"; 
                amtN.innerText = "ç¶­æŒç¾ç‹€"; 
                badge.className = "text-[10px] px-2 py-0.5 rounded text-white bg-emerald-500"; 
                badge.innerText = "WAIT"; 
            } else if (r > vTar + vTol) { 
                title.innerText = "å»ºè­°è³£å‡º (SELL)"; 
                title.className = "text-base font-bold text-rose-400"; 
                amt1.innerText = `è³£å‡º ${Math.abs(diff).toLocaleString('zh-TW')} (1X)`; 
                amtN.innerText = `è³£å‡º ${Math.abs(diff/vMult).toLocaleString('zh-TW')} (Nx)`; 
                badge.className = "text-[10px] px-2 py-0.5 rounded text-white bg-rose-500"; 
                badge.innerText = "ACTION"; 
            } else { 
                title.innerText = "å»ºè­°è²·é€² (BUY)"; 
                title.className = "text-base font-bold text-amber-400"; 
                amt1.innerText = `è²·é€² ${Math.abs(diff).toLocaleString('zh-TW')} (1X)`; 
                amtN.innerText = `è²·é€² ${Math.abs(diff/vMult).toLocaleString('zh-TW')} (Nx)`; 
                badge.className = "text-[10px] px-2 py-0.5 rounded text-white bg-amber-500"; 
                badge.innerText = "ACTION"; 
            }
        }
        
        disp('netWorthDisplay', "$" + Math.round(net).toLocaleString('zh-TW'));

        const mtnCard = document.getElementById('mtnCard');
        if (vLoan > 0) {
            mtnCard.classList.remove('hidden');
            const mtn = ((vS2+vS1)/vLoan)*100;
            document.getElementById('mtnValue').innerText = mtn.toFixed(0) + "%";
            document.getElementById('mtnBar').style.width = Math.min(mtn/2.5, 100) + "%";
            const bar = document.getElementById('mtnBar'), bdg = document.getElementById('mtnBadge'), valEl = document.getElementById('mtnValue'), desc = document.getElementById('mtnDesc');
            bar.className = 'h-full transition-all duration-500'; bdg.className = 'text-[10px] px-2 py-0.5 rounded transition-colors duration-500'; valEl.classList.remove('text-rose-400');
            if (mtn < 130) { bdg.innerText="DANGER"; desc.innerText="âš ï¸ è­¦å‘Šï¼šä½æ–¼ 130%ï¼éœ€è£œéŒ¢æˆ–è³£å‡ºã€‚"; bar.classList.add('bg-rose-500'); bdg.classList.add('bg-rose-500','text-white','animate-pulse'); valEl.classList.add('text-rose-400'); }
            else if (mtn < 166) { bdg.innerText="Warning"; desc.innerText="æ³¨æ„ï¼šä½æ–¼ 166%ï¼Œç¶­æŒç‡åä½ã€‚"; bar.classList.add('bg-yellow-500'); bdg.classList.add('bg-yellow-500','text-black'); }
            else { bdg.innerText="Safe"; desc.innerText="ç¶­æŒç‡å¥åº·ã€‚"; bar.classList.add('bg-emerald-500'); bdg.classList.add('bg-emerald-500','text-white'); }
        } else { mtnCard.classList.add('hidden'); }
    };

    // Simulate (Updated with Slider)
    const apiKey = ""; const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
    async function callGemini(sys, usr) {
        const payload = { contents: [{ parts: [{ text: usr }] }], systemInstruction: { parts: [{ text: sys }] } };
        for (let i = 0; i < 3; i++) {
            try { const res = await fetch(apiUrl + `?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!res.ok) { if (res.status === 429 && i < 2) { await new Promise(r => setTimeout(r, 2000)); continue; } throw new Error(res.status); }
                const json = await res.json(); return json.candidates?.[0]?.content?.parts?.[0]?.text || "Error";
            } catch (e) { if (i===2) throw e; await new Promise(r => setTimeout(r, 2000)); }
        }
    }

    window.simulateRisk = async () => {
        const llmCard = document.getElementById('llmResultCard'), llmText = document.getElementById('llmResultText'), loader = document.getElementById('llmLoader'), btn = document.getElementById('simulateBtn');
        llmCard.classList.remove('hidden'); llmText.innerText = "AI åˆ†æä¸­..."; loader.classList.remove('hidden'); btn.disabled = true;

        const vS2 = parseFloat(els.stock2x.value)||0, vS1 = parseFloat(els.stock1x.value)||0, vLoan = parseFloat(els.collateralLoan.value)||0;
        const totalCol = vS2 + vS1;
        
        // Get custom drop percent
        const dropSlider = document.getElementById('dropSlider');
        const dropPercent = parseInt(dropSlider ? dropSlider.value : 20);
        const marketDrop = dropPercent / 100;

        const newCol = totalCol * (1 - marketDrop);
        const newMtn = (newCol / vLoan) * 100;
        const reqCol = vLoan * 1.66;
        const cashReq = Math.max(0, reqCol - newCol);
        const curMtn = (totalCol / vLoan * 100).toFixed(2);

        const sys = "æ‚¨æ˜¯å°ˆæ¥­é‡‘èé¢¨éšªåˆ†æå¸«ã€‚è«‹é‡å°ç”¨æˆ¶è¨­å®šçš„å¸‚å ´è·Œå¹…æƒ…å¢ƒé€²è¡Œå£“åŠ›æ¸¬è©¦åˆ†æã€‚è«‹ä»¥ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£å°ˆæ¥­ä¸”ä¿å®ˆï¼Œé‡é»æ”¾åœ¨ç¶­æŒç‡è®ŠåŒ–èˆ‡è£œéŒ¢å»ºè­°ã€‚";
        const usr = `ç›®å‰æ•¸æ“šï¼š\n- æ“”ä¿å“: ${Math.round(totalCol).toLocaleString()} TWD\n- å€Ÿæ¬¾: ${Math.round(vLoan).toLocaleString()} TWD\n- ç¶­æŒç‡: ${curMtn}%\n\næƒ…å¢ƒå‡è¨­ï¼šå¸‚å ´ä¸‹è·Œ ${dropPercent}%ã€‚\n\nåˆ†æçµæœéœ€æ±‚ï¼š\n1. æ–°çš„æ“”ä¿å“å¸‚å€¼\n2. æ–°çš„ç¶­æŒç‡\n3. è‹¥è¦å›åˆ° 166% ç¶­æŒç‡ï¼Œéœ€è£œå…¥å¤šå°‘ç¾é‡‘ (æ•¸å€¼ç‚º ${Math.round(cashReq).toLocaleString()} TWD)\n4. ç°¡çŸ­é¢¨éšªå»ºè­°`;

        try { const txt = await callGemini(sys, usr); llmText.innerText = txt; }
        catch (e) { llmText.innerText = `æ¨¡æ“¬åˆ†æ (æœ¬æ©Ÿæ¨¡å¼):\n- è·Œå¹…è¨­å®š: ${dropPercent}%\n- æ–°ç¶­æŒç‡: ${newMtn.toFixed(2)}%\n- å»ºè­°è£œéŒ¢ (è‡³166%): $${Math.round(cashReq).toLocaleString()}\n\n(é€£ç·šå¤±æ•—: ${e.message})`; }
        finally { loader.classList.add('hidden'); btn.disabled = false; }
    };

    function showToast(msg, type) {
        const div = document.createElement('div'); div.className = `p-3 mb-2 rounded shadow-lg text-white text-sm animate-bounce ${type==='error'?'bg-rose-600':(type==='info'?'bg-blue-600':'bg-emerald-600')}`;
        div.innerText = msg; document.getElementById('toastContainer').appendChild(div); setTimeout(()=>div.remove(), 3000);
    }

    // --- æ–°å¢æˆæ¬Šé‚è¼¯ ---

    // æˆæ¬Šè™•ç†å‡½å¼
    window.handleAuthSubmit = () => {
        const inputEl = document.getElementById('authCodeInput');
        const errorEl = document.getElementById('authError');
        const code = inputEl.value.trim();

        errorEl.innerText = '';
        if (code === AUTH_CODE) {
            localStorage.setItem('isAuthorized', 'true'); // å„²å­˜æˆåŠŸç‹€æ…‹
            document.getElementById('authModal').classList.add('opacity-0', 'pointer-events-none');
            // æˆæ¬ŠæˆåŠŸå¾Œï¼Œé–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
            initApp();
        } else {
            errorEl.innerText = 'âŒ æˆæ¬Šç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚';
            inputEl.value = '';
        }
    };
    
    // æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒåˆå§‹åŒ–å‡½å¼ (åŸå…ˆåˆ†æ•£åœ¨åº•éƒ¨)
    async function initApp() {
        initEls(); 
        await initFirebase(); // Firebase åˆå§‹åŒ–å¿…é ˆåœ¨æˆæ¬Šå¾Œ
        attachEvents();
        window.calculate(); // é¦–æ¬¡è¨ˆç®—
    }

    // æª¢æŸ¥æˆæ¬Šç‹€æ…‹
    function checkAuthStatus() {
        const authModal = document.getElementById('authModal');
        const isAuth = localStorage.getItem('isAuthorized') === 'true';

        if (isAuth) {
            authModal.classList.add('opacity-0', 'pointer-events-none');
            initApp();
        } else {
            // å¦‚æœæœªæˆæ¬Šï¼Œé¡¯ç¤ºæ¨¡æ…‹æ¡†ä¸¦é˜»æ­¢äº’å‹•
            authModal.classList.remove('opacity-0', 'pointer-events-none');
        }
    }

    // é é¢è¼‰å…¥æ™‚é–‹å§‹æª¢æŸ¥æˆæ¬Š
    checkAuthStatus();
</script>
</body>
</html>


